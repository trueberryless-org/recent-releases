---
import type { ReleaseInfo } from "../types";

interface Props {
  item: ReleaseInfo;
  prev?: ReleaseInfo;
  config: {
    name: string;
    login: string;
  };
}

const { item, prev, config } = Astro.props;

const timeDiffHours = prev
  ? Math.abs(
      new Date(prev.created_at).getTime() - new Date(item.created_at).getTime()
    ) /
    1000 /
    60 /
    60
  : 0;

function getHighlightedVersion(version: string) {
  const parts = version.split(/(\.)/g);

  let highlightedIndex = -1;
  for (let i = parts.length - 1; i >= 0; i--) {
    if (parts[i] !== ".") {
      const num = +parts[i]!;
      if (!Number.isNaN(num) && num > 0) {
        highlightedIndex = i;
        break;
      }
    }
  }

  const mergedParts = [
    parts.slice(0, highlightedIndex).join(""),
    parts.slice(highlightedIndex).join(""),
  ];

  const colors = ["rose", "green", "purple", "teal"];
  const colorIndex = Math.min(
    Math.floor(highlightedIndex / 2),
    colors.length - 1
  );
  const color =
    highlightedIndex >= 0 ? colors[colorIndex] : colors[colors.length - 1];

  return { mergedParts, color };
}

const { mergedParts, color } = getHighlightedVersion(item.version);

function formatTimeAgo(date: Date): string {
  const now = new Date();
  const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);

  if (diffInSeconds < 60) return "just now";
  if (diffInSeconds < 3600)
    return `${Math.floor(diffInSeconds / 60)} minutes ago`;
  if (diffInSeconds < 86400)
    return `${Math.floor(diffInSeconds / 3600)} hours ago`;
  if (diffInSeconds < 2592000)
    return `${Math.floor(diffInSeconds / 86400)} days ago`;
  if (diffInSeconds < 31536000)
    return `${Math.floor(diffInSeconds / 2592000)} months ago`;
  return `${Math.floor(diffInSeconds / 31536000)} years ago`;
}
---

<div class={`item ${timeDiffHours > 11 ? "mt-large" : ""}`}>
  <a
    href={`https://github.com/trueberryless-org/${item.package}`}
    target="_blank"
    class="logo-link"
  >
    <img
      src={`https://github.com/trueberryless-org.png`}
      alt={item.package}
      class="logo rounded"
    />
  </a>

  <div class="content">
    <div class="main">
      <a
        href={`https://github.com/trueberryless-org/${item.package}`}
        target="_blank"
        class="repo-link"
      >
        <div class="owner">
          trueberryless-org<span class="slash">/</span>
        </div>
        <div class="name">{item.package}</div>
      </a>
      <a href={item.commit} target="_blank" class="commit">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 256 256"
          class="commit-icon"
        >
          <path
            fill="currentColor"
            d="M248,120H183.42a56,56,0,0,0-110.84,0H8a8,8,0,0,0,0,16H72.58a56,56,0,0,0,110.84,0H248a8,8,0,0,0,0-16ZM128,168a40,40,0,1,1,40-40A40,40,0,0,1,128,168Z"
          ></path>
        </svg>
        {item.title}
      </a>
    </div>
    <div class="meta">
      <a
        href={`https://github.com/trueberryless-org/${item.package}/releases${
          item.package && item.version
            ? `/tag/${item.package}@${item.version}`
            : item.version
              ? `/tag/v${item.version}`
              : ""
        }`}
        target="_blank"
        class="version"
      >
        <span>v</span>{mergedParts[0]}<span class={`highlight ${color}`}
          >{mergedParts[1]}</span
        >
      </a>
      <time datetime={new Date(item.created_at).toISOString()} class="time">
        {formatTimeAgo(new Date(item.created_at))}
      </time>
    </div>
  </div>
</div>

<style>
  .item {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .mt-large {
    margin-top: 2.5rem;
  }

  @media (max-width: 640px) {
    .item {
      gap: 1.5rem;
    }
  }

  .logo-link {
    position: relative;
    flex-shrink: 0;
    display: block;
  }

  .logo {
    height: 3rem;
    width: 3rem;
    border: 1px solid rgba(128, 128, 128, 0.05);
    background-color: rgba(128, 128, 128, 0.05);
    display: block;
  }

  @media (max-width: 640px) {
    .logo {
      height: 3.5rem;
      width: 3.5rem;
    }
  }

  .logo.rounded {
    border-radius: 0.5rem;
  }

  .logo.square {
    border-radius: 0.25rem;
  }

  .sub-logo {
    border: 1px solid rgba(128, 128, 128, 0.05);
    position: absolute;
    bottom: -0.5rem;
    right: -0.5rem;
    border-radius: 50%;
    background-color: white;
    padding: 0.25rem;
  }

  html.dark .sub-logo {
    background-color: #121212;
  }

  .sub-img {
    display: block;
    margin: auto;
    height: 1.25rem;
    width: 1.25rem;
  }

  .sub-icon {
    display: block;
    margin: auto;
    height: 1.125rem;
    width: 1.125rem;
  }

  .content {
    display: flex;
    flex-direction: row;
    gap: 0.5rem;
    flex: 1 1 auto;
    align-items: center;
    min-width: 0;
  }

  @media (max-width: 640px) {
    .content {
      flex-direction: column;
      align-items: flex-start;
    }
  }

  .main {
    display: flex;
    flex-direction: column;
    flex: 1 1 auto;
    min-width: 0;
  }

  .repo-link {
    display: flex;
    flex-direction: column;
    flex-wrap: wrap;
    min-width: 0;
  }

  .owner {
    font-size: 0.875rem;
    line-height: 1.25rem;
    opacity: 0.5;
  }

  .slash {
    opacity: 0.75;
  }

  .name {
    margin-top: -0.125rem;
    font-size: 1.125rem;
    line-height: 1.5rem;
  }

  .commit {
    display: flex;
    gap: 0.125rem;
    align-items: center;
    margin-left: -0.25rem;
    font-size: 0.875rem;
    line-height: 1.25rem;
    opacity: 0.5;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  @media (max-width: 640px) {
    .commit {
      display: none;
    }
  }

  .commit-icon {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
  }

  .meta {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    text-align: right;
    flex-shrink: 0;
  }

  @media (max-width: 640px) {
    .meta {
      flex-direction: row;
      gap: 0.5rem;
    }
  }

  .version {
    font-family:
      ui-monospace, "Cascadia Code", "Source Code Pro", Menlo, Consolas,
      "DejaVu Sans Mono", monospace;
    font-size: 1rem;
    line-height: 1.5rem;
    white-space: nowrap;
  }

  .highlight {
    font-weight: 700;
    padding: 0.1rem 0.25rem;
    margin: 0 -0.1rem;
    border-radius: 0.25rem;
  }

  .highlight.rose {
    color: #be123c;
    background-color: rgba(244, 63, 94, 0.15);
  }

  html.dark .highlight.rose {
    color: #fda4af;
  }

  .highlight.green {
    color: #15803d;
    background-color: rgba(34, 197, 94, 0.15);
  }

  html.dark .highlight.green {
    color: #86efac;
  }

  .highlight.purple {
    color: #7e22ce;
    background-color: rgba(168, 85, 247, 0.15);
  }

  html.dark .highlight.purple {
    color: #d8b4fe;
  }

  .highlight.teal {
    color: #0f766e;
    background-color: rgba(20, 184, 166, 0.15);
  }

  html.dark .highlight.teal {
    color: #5eead4;
  }

  .time {
    font-size: 0.875rem;
    line-height: 1.25rem;
    opacity: 0.5;
    white-space: nowrap;
  }
</style>
