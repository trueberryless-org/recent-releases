---
import type { ReleaseInfo } from "../types";

interface Props {
  item: ReleaseInfo;
  prev?: ReleaseInfo;
  config: {
    name: string;
    login: string;
  };
}

const { item, prev, config } = Astro.props;

const logoOverrides: Record<string, string> = {
  "antfu/vscode-array-index-inlay":
    "https://github.com/antfu/vscode-array-index-inlay/raw/main/res/icon.png?raw=true",
  "antfu/vscode-smart-clicks":
    "https://raw.githubusercontent.com/antfu/vscode-smart-clicks/main/res/icon.png",
  "antfu/vscode-pnpm-catalog-lens":
    "https://raw.githubusercontent.com/antfu/vscode-pnpm-catalog-lens/main/res/icon.png",
};

const subLogosMatch: [RegExp, string][] = [
  [/^nuxt-/, "i-logos-nuxt-icon"],
  [/^vite-/, "i-logos-vitejs"],
  [/^eslint-/, "i-logos-eslint"],
  [/^vscode-/, "i-logos-visual-studio-code"],
  [/^shiki-/i, "https://github.com/shikijs.png"],
  [/^slidev-/, "https://github.com/slidevjs.png"],
];

const timeDiffHours = prev
  ? Math.abs(
      new Date(prev.created_at).getTime() - new Date(item.created_at).getTime()
    ) /
    1000 /
    60 /
    60
  : 0;

let subImage = "";
if (item.repo.startsWith(`${config.login}/`) && !logoOverrides[item.repo]) {
  const name = item.repo.split("/")[1]!;
  for (const [re, img] of subLogosMatch) {
    if (re.test(name)) {
      subImage = img;
      break;
    }
  }
}

function getHighlightedVersion(version: string) {
  const parts = version.split(/(\.)/g);

  let highlightedIndex = -1;
  for (let i = parts.length - 1; i >= 0; i--) {
    if (parts[i] !== ".") {
      const num = +parts[i]!;
      if (!Number.isNaN(num) && num > 0) {
        highlightedIndex = i;
        break;
      }
    }
  }

  const mergedParts = [
    parts.slice(0, highlightedIndex).join(""),
    parts.slice(highlightedIndex).join(""),
  ];

  const colors = ["rose", "green", "purple", "teal"];
  const colorIndex = Math.min(
    Math.floor(highlightedIndex / 2),
    colors.length - 1
  );
  const color =
    highlightedIndex >= 0 ? colors[colorIndex] : colors[colors.length - 1];

  return { mergedParts, color };
}

const { mergedParts, color } = getHighlightedVersion(item.version);

function formatTimeAgo(date: Date): string {
  const now = new Date();
  const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);

  if (diffInSeconds < 60) return "just now";
  if (diffInSeconds < 3600)
    return `${Math.floor(diffInSeconds / 60)} minutes ago`;
  if (diffInSeconds < 86400)
    return `${Math.floor(diffInSeconds / 3600)} hours ago`;
  if (diffInSeconds < 2592000)
    return `${Math.floor(diffInSeconds / 86400)} days ago`;
  if (diffInSeconds < 31536000)
    return `${Math.floor(diffInSeconds / 2592000)} months ago`;
  return `${Math.floor(diffInSeconds / 31536000)} years ago`;
}
---

<div class={`item ${timeDiffHours > 11 ? "mt-large" : ""}`}>
  <a href={`https://github.com/${item.repo}`} target="_blank" class="logo-link">
    <img
      src={logoOverrides[item.repo] ||
        `https://github.com/${item.repo.split("/")[0]}.png`}
      alt={item.repo}
      class={`logo ${
        item.isOrg === false && !logoOverrides[item.repo] ? "rounded" : "square"
      }`}
    />

    {
      subImage && (
        <div class="sub-logo">
          {subImage.includes("://") ? (
            <img src={subImage} alt="Sub logo" class="sub-img" />
          ) : (
            <div class={`${subImage} sub-icon`} />
          )}
        </div>
      )
    }
  </a>

  <div class="content">
    <div class="main">
      <div class="repo">
        <a
          href={`https://github.com/${item.repo}`}
          target="_blank"
          class="repo-link"
        >
          <div class="owner">
            {item.repo.split("/")[0]}<span class="slash">/</span>
          </div>
          <div class="name">{item.repo.split("/")[1]}</div>
        </a>
      </div>
      <a href={item.commit} target="_blank" class="commit">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 256 256"
          class="commit-icon"
        >
          <path
            fill="currentColor"
            d="M248 120h-66a46 46 0 0 0-84 0H32a8 8 0 0 0 0 16h66a46 46 0 0 0 84 0h66a8 8 0 0 0 0-16m-108 30a30 30 0 1 1 30-30a30 30 0 0 1-30 30"
          ></path>
        </svg>
        {item.title}
      </a>
    </div>
    <div class="meta">
      <a
        href={`https://github.com/${item.repo}/releases${
          item.package && item.version
            ? `/tag/${item.package}@${item.version}`
            : item.version
              ? `/tag/v${item.version}`
              : ""
        }`}
        target="_blank"
        class="version"
      >
        <span>v</span>{mergedParts[0]}<span class={`highlight ${color}`}
          >{mergedParts[1]}</span
        >
      </a>
      <time datetime={new Date(item.created_at).toISOString()} class="time">
        {formatTimeAgo(new Date(item.created_at))}
      </time>
    </div>
  </div>
</div>

<style>
  .item {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .mt-large {
    margin-top: 2.5rem;
  }

  @media (max-width: 640px) {
    .item {
      gap: 1.5rem;
    }
  }

  .logo-link {
    position: relative;
    flex-shrink: 0;
    display: block;
  }

  .logo {
    height: 3rem;
    width: 3rem;
    border: 1px solid rgba(128, 128, 128, 0.05);
    background-color: rgba(128, 128, 128, 0.05);
  }

  @media (max-width: 640px) {
    .logo {
      height: 3.5rem;
      width: 3.5rem;
    }
  }

  .logo.rounded {
    border-radius: 50%;
  }

  .logo.square {
    border-radius: 0.25rem;
  }

  .sub-logo {
    border: 1px solid rgba(128, 128, 128, 0.05);
    position: absolute;
    bottom: -0.5rem;
    right: -0.5rem;
    border-radius: 50%;
    background-color: white;
    padding: 0.25rem;
  }

  html.dark .sub-logo {
    background-color: #121212;
  }

  .sub-img {
    display: block;
    margin: auto;
    height: 1.25rem;
    width: 1.25rem;
  }

  .sub-icon {
    display: block;
    margin: auto;
    height: 1.125rem;
    width: 1.125rem;
  }

  .content {
    display: flex;
    flex-direction: row;
    gap: 0.5rem;
    flex: 1;
    align-items: center;
  }

  @media (max-width: 640px) {
    .content {
      flex-direction: column;
      align-items: flex-start;
    }
  }

  .main {
    display: flex;
    flex-direction: column;
    flex: 1;
  }

  .repo {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  .repo-link {
    display: flex;
    flex-direction: column;
    flex-wrap: wrap;
  }

  .owner {
    font-size: 0.875rem;
    opacity: 0.5;
  }

  .slash {
    opacity: 0.75;
  }

  .name {
    margin-top: -0.125rem;
    font-size: 1.125rem;
  }

  .commit {
    display: flex;
    gap: 0.125rem;
    align-items: center;
    margin-left: -0.25rem;
    font-size: 0.875rem;
    opacity: 0.5;
  }

  @media (max-width: 640px) {
    .commit {
      display: none;
    }
  }

  .commit-icon {
    width: 1rem;
    height: 1rem;
  }

  .meta {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    text-align: right;
  }

  @media (max-width: 640px) {
    .meta {
      flex-direction: row;
      gap: 0.5rem;
    }
  }

  .version {
    font-family:
      ui-monospace, "Cascadia Code", "Source Code Pro", Menlo, Consolas,
      "DejaVu Sans Mono", monospace;
  }

  .highlight {
    font-weight: 700;
    padding: 0 0.2rem;
    margin: 0 -0.2rem;
    border-radius: 0.125rem;
  }

  .highlight.rose {
    color: #be123c;
    background-color: rgba(244, 63, 94, 0.15);
  }

  html.dark .highlight.rose {
    color: #fda4af;
  }

  .highlight.green {
    color: #15803d;
    background-color: rgba(34, 197, 94, 0.15);
  }

  html.dark .highlight.green {
    color: #86efac;
  }

  .highlight.purple {
    color: #7e22ce;
    background-color: rgba(168, 85, 247, 0.15);
  }

  html.dark .highlight.purple {
    color: #d8b4fe;
  }

  .highlight.teal {
    color: #0f766e;
    background-color: rgba(20, 184, 166, 0.15);
  }

  html.dark .highlight.teal {
    color: #5eead4;
  }

  .time {
    font-size: 0.875rem;
    opacity: 0.5;
  }
</style>
